# Импорт JSON
Данная инструкция описывает пример настройки цепочки преобразований, включающей объект "Программный обработчик", предназначенный для импорта данных из JSON файла, размещенного в файловом хранилище.
### Шаг 1: Загрузка файла в файловое хранилище
Перейдите в раздел **"Файлы"** и загрузите файл формата JSON с данными.
![1_File_section.png](../images/7_Workflow/JSON/1_File_section.png)
Пример файла:
```json
{
     "data": [
       {
         "id": 1,
         "name": "Объект 1"
       },
       {
         "id": 2,
         "name": "Объект 2"
       }
     ]
   }
```
> Корневой объект должен содержать одно поле с массивом объектов (в данном примере — поле data).

Убедитесь, что файл успешно добавлен в файловое хранилище.
![2_add_json.png](../images/7_Workflow/JSON/2_add_json.png)
### Шаг 2: Инициализация обработчика
В разделе "**Цепочки**" настройте программный обработчик:

1. Выберите программный обработчик из списка.

![4_Choose_processor.png](../images/7_Workflow/JSON/4_Choose_processor.png)
**Результат:** в рабочей области появится объект обработчика в виде блока с синим заголовком.

![5_Json processor in workspace.png](../images/7_Workflow/JSON/5_Json%20processor%20in%20workspace.png)
### Шаг 3: Настройка параметров обработчика
В разделе "Цепочки" настройте параметры процессора:

1. Нажмите **params** на блоке, в результате чего отобразится панель для настройки параметров.

![7_params_field.png](../images/7_Workflow/JSON/7_params_field.png)
1. В форме "**Данные**" пропишите параметры процессора в формате Json:

- Скопируйте путь к загруженному JSON файлу из раздела "Файлы".

![6_Copy_path.png](../images/7_Workflow/JSON/6_Copy_path.png)

- В поле "**file_path**" подставьте путь к файлу в файловом хранилище.
- В поле "**array_field**": введите имя поля, содержащего массив объектов (в данном примере — data).

![8_params_value.png](../images/7_Workflow/JSON/8_params_value.png)
```json
{
    "file_path": "путь_к_JSON_файлу.json",
    "array_field": "data"
}
```
Сохраните импортированные данные в коллекцию:

1. Выберите коллекцию из списка на нижней панели.
 ![9_add_collection.png](../images/7_Workflow/JSON/9_add_collection.png)
 **Результат:** в рабочей области появится объект обработчика в виде блока с желтым заголовком.
2. Подключите выходную коллекцию к обработчику.
![10_add_svyaz.png](../images/7_Workflow/JSON/10_add_svyaz.png)
### Шаг 4: Запуск обработчика
Нажмите кнопку запуска на блоке обработчика.
![11_Zapusk_blocka.png](../images/7_Workflow/JSON/11_Zapusk_blocka.png)
**Результат:** в рабочей области отобразится статус успешного выполнения.
![12_success_zapusk.png](../images/7_Workflow/JSON/12_success_zapusk.png)
### Шаг 5: Проверка результата
В разделе "**Коллекции**" убедитесь, что данные из JSON файла корректно добавлены в выбранную коллекцию.
![13_collection_data.png](../images/7_Workflow/JSON/13_collection_data.png)
### Шаг 6: Отладка скрипта
Если обработчик возвращает ошибку:
![14_bad_zapusk.png](../images/7_Workflow/JSON/14_bad_zapusk.png)
![15_bad_zapusk_mastakes_window.png](../images/7_Workflow/JSON/15_bad_zapusk_mastakes_window.png)
Нажмите на заголовок блока, чтобы открыть панель настройки обработчика.
![16_widnow_config_processor.png](../images/7_Workflow/JSON/16_widnow_config_processor.png)
В панели настройки вызовите функцию скрипта для отладки.
![17_scrypt_dlya_otladki.png](../images/7_Workflow/JSON/17_scrypt_dlya_otladki.png)
Скопируйте текст скрипта в среду разработки и выполните отладку.

# Импорт Excel
Ниже описан пример настройки цепочки преобразований, включающих объекты "Программный обработчик" и "Коллекция".
1. В разделе "Файлы" загрузите файл формата XSLX.

![upload_file_to_s3.png](../images/7_Workflow/7_2_Program_obrabotchik_Excel/upload_file_to_s3.png)

### Инициализация обработчика

1. В разделе "Цепочки" настройте обработчик.

![Вызов списка обработчиков.png](../images/7_Workflow/7_2_Program_obrabotchik_Excel/Вызов%20списка%20обработчиков.png)

    - Выберите обрабочик из списка.
*В результате, выбранный объект отобразится в рабочей области в виде блока с синим заголовком*

    - Скопируйте путь к файлу в разделе “Файлы”.

![copy_path.png](../images/7_Workflow/7_2_Program_obrabotchik_Excel/copy_path.png)

    - Задайте параметры в поле params:

```json
{
    "file_path": "путь_к_тестовому_файлу.xlsx"
}
```
    - Подключите выходную коллекцию к обработчику.

![Add_collection.png](../images/7_Workflow/7_2_Program_obrabotchik_Excel/Add_collection.png)

    - Запустите обработчик.

![Launch_processor.png](../images/7_Workflow/7_2_Program_obrabotchik_Excel/Launch_processor.png)

**Результат:** В рабочей области должен отобразиться статус успешного запуска процесса, а в списке коллекций объект с данными из хранилища.

![Success_action.png](../images/7_Workflow/7_2_Program_obrabotchik_Excel/Success_action.png)

3. Проверьте, что данные из ```XLSX``` файла корректно добавлены в раздел "Коллекции".

### Отладка скрипта

> В случае, если запуск обработчика возвращает ошибку, отладьте скрипт вручную.

4. Нажмите на заголовок блока.

![Tap_block_header.png](../images/7_Workflow/7_2_Program_obrabotchik_Excel/Tap_block_header.png)

**Результат:** слева отобразится панель настройки обработчика.

5. Вызовите функцию скрипта для отладки.

![Config_processor.png](../images/7_Workflow/7_2_Program_obrabotchik_Excel/Config_processor.png)

6. Скопируйте текст и отладьте его в среде разработки.

![Script_text.png](../images/7_Workflow/7_2_Program_obrabotchik_Excel/Script_text.png)
# Семантический запрос
Ниже описан пример настройки цепочки преобразований с использованием объекта "**Программный обработчик**", выполняющего семантический запрос.
### Шаг 1: Загрузка данных и подготовка
Перейдите в программное приложение **Редактор модели** и, в списке "**Онтологии**", выберите "**Семантические запросы**".
![1_model_editor_ontology.png](../images/7_Workflow/Sem_query/1_model_editor_ontology.png)
Скопируйте идентификатор запроса без префикса.
![2_IRI_sem_query.png](../images/7_Workflow/Sem_query/2_IRI_sem_query.png)
### Шаг 2: Инициализация обработчика
В разделе "Цепочки" настройте программный обработчик:
* Выберите обработчик для семантического запроса из списка.
* Обработчик отобразится в рабочей области в виде блока с синим заголовком.

![3_sem_query_block.png](../images/7_Workflow/Sem_query/3_sem_query_block.png)
### Шаг 3: Настройка параметров обработчика
В блоке обработчика нажмите params, чтобы открыть панель настройки параметров.
![4_sem_query_params.png](../images/7_Workflow/Sem_query/4_sem_query_params.png)
Задайте параметры обработчика в формате JSON:
* format: укажите формат данных на выходе (csv для плоского формата или json для иерархического).
* sem_query_id: задайте идентификатор семантического запроса без префикса.
* root_entity_ids: перечислите идентификаторы объектов без префиксов (необязательный параметр). Если он отсутствует, запрос применяется ко всем объектам нужного типа.
Пример параметров для csv-формата:
```json
{
    "format": "csv",
    "sem_query_id": "SemanticQuery_22815230-67d7-4de8-927a-002010abad77"
}
```
Пример параметров для json-формата:
```json
{
    "format": "json",
    "sem_query_id": "SemanticQuery_c061e503-c81c-4c64-9ad9-7047cb2e9ed6",
     "root_entity_ids": [
            "e6e30190-624c-4664-b649-47f833d2a869",
            "556bcf33-0d51-4303-b193-62a6ad389318"
        ]
}
```
Подключите выходную коллекцию:
* Выберите коллекцию из списка в нижней панели.
* Соедините блок обработчика с выходной коллекцией.
![5_add_correct_collection.png](../images/7_Workflow/Sem_query/5_add_correct_collection.png)
> В результате запуска обработчика может возникнуть ошибка, связанная с некорректным форматированием входного CSV-файла.
* Добавьте еще одну коллекцию на вход для записи расхождения в данных.

![6_add_incorrect_collection.png](../images/7_Workflow/Sem_query/6_add_incorrect_collection.png)
> Коллекция должна быть добавлена в тот же порт.
### Шаг 4: Запуск обработчика
Нажмите на элемент запуска блока обработчика.
![7_start_block.png](../images/7_Workflow/Sem_query/7_start_block.png)
**Результат:** 
В рабочей области отобразится статус успешного выполнения. Данные будут сохранены в формате JSON или CSV в зависимости от указанных параметров.
### Шаг 5: Проверка результата
В разделе "Коллекции" убедитесь, что данные корректно добавлены в выбранную коллекцию.
![Семантический запрос. Результат](../images/7_Workflow/Sem_query/8_sem_query_result.png)
# Сопоставление
Программный обработчик "**Сопоставление**" выполняет следующие задачи:

* Сопоставление объектов из различных систем по выделенному ключу.
* Формирование выходных данных в соответствии с алгоритмом:
     * Дубликаты объектов.
     * Справочники ключей без дубликатов. 
     * Сопоставленные объекты с указанием идентификаторов систем. 
     * Несопоставленные объекты для каждой системы.
#### Входные данные
Для корректной работы обработчика необходимо соблюсти имена полей коллекции:

* Система: идентификатор системы (например, "СУПА"). 
* Тип объекта: тип объектов (например, "подстанции"). 
* Ключ: уникальный ключ для сопоставления. 
* Идентификатор: уникальный идентификатор объекта.

#### Выходные данные
После выполнения обработчика пользователь получает следующие результаты:

1. Дубликаты: список объектов, имеющих повторяющиеся ключи сопоставления. Выводится отдельно для каждой системы.
2. Справочники ключей: список входных объектов без дубликатов.
3. Сопоставленные объекты: объекты, для которых ключи совпадают, объединяются следующим образом:
    * Запись из справочника ключей системы 1 с добавлением идентификатора системы 2.
    * Запись из справочника ключей системы 2 с добавлением идентификатора системы 1.
4. Несопоставленные объекты: списки объектов, для которых не найдено совпадение по ключу, отдельно для каждой системы.

### Порядок работы

1. Добавьте обработчик в рабочую область.  
   ![1_add_processor.png](../images/7_Workflow/Comparation/1_add_processor.png)

2. Добавьте входные коллекции и подключите их к процессору.  
   ![2_add_source.png](../images/7_Workflow/Comparation/2_add_source.png)

   Обработчик поддерживает два способа подключения входных данных:

   - **Явное подключение**: пользователь вручную задаёт коллекции для системы 1 и системы 2.
   - **Подключение по маске**: использованием маски можно подключить сразу несколько коллекций, соответствующих указанным условиям (например, все типы оборудования из определённой системы).

<ol start="3">
  <li>Добавьте выходные данные и задайте им имена.</li>
  <li>Запустите обработчик.</li>
</ol>

![3_launch_processor.png](../images/7_Workflow/Comparation/3_launch_processor.png)

**Результат:**  
Выходные данные будут добавлены в раздел коллекции.  
![4_output_data.png](../images/7_Workflow/Comparation/4_output_data.png)

# Набор коллекций по маске
Данная функция предназначена для подключения набора коллекций в **обработчике** с использованием маски. Это позволяет:

* Обрабатывать данные сразу из нескольких коллекций.
* Разделять данные из одной коллекции (выход обработчика) на несколько коллекций.
### Входные данные
**Порядок работы:**

1. Откройте исходную цепочку преобразований.
![1_source_workflow.png](../images/7_Workflow/Mask/1_source_workflow.png)
> Обратите внимание, что в источнике параметры не заполнены.
2. Задайте маску в параметрах цепочки преобразований:
    * Нажмите на объект, по которому хотите задать маску.
    * В отобразившемся окне, введите параметры маски через нижнее подчеркивание:
        * Укажите постоянную часть маски для общей части наименования коллекции.
        * Укажите переменную часть маски в фигурных скобках.
![2_mask_params.png](../images/7_Workflow/Mask/2_mask_params.png)

**Результат:**
Обработчик автоматически найдет все коллекции, содержащие постоянную часть маски
![2_mask_params_result.png](../images/7_Workflow/Mask/2_mask_params_result.png)

**Пример 1:**

* Введите маску **"СК-11_{x}"**, где **"СК-11"** является постоянной частью, а **"{x}"** - переменной.
* Введите маску **"СУПА_{y}"**, где **"СУПА"** является постоянной частью, а **"{y}"** - переменной.

**Результат:**

В окно с параметрами подтянутся все коллекции из текущей БД:

* В имени которых будет присутствовать постоянная часть маски **"СК-11"** и **"СУПА"**.
* Структура маски будет соответствовать - **"[постоянная часть]\_{переменная часть}"**.
![3_mask_params_example_1.png](../images/7_Workflow/Mask/3_mask_params_example_1.png)
**Пример 2:**

* Задайте маску **"{x}\_{y}\_unmatched"**, где **"x"** и **"у"** - переменные, а **"unmatched"** - постоянная часть.

**Результат:**

В окно с параметрами подтянутся все коллекции из текущей БД:

* В имени которых будет присутствовать постоянная часть маски **"unmatched"**.
* Структура маски будет соответствовать - **"{переменная часть}\_{переменная часть}\_[постоянная часть]"**.
![3_mask_params_example_2.png](../images/7_Workflow/Mask/3_mask_params_example_2.png)
После настройки маски запустите обработчик. Для проверки результата, нажмите на необходимый блок и отобразите данные.
![4_mask_result.png](../images/7_Workflow/Mask/4_mask_result.png)

**Результат:**

Производные данные содержат поля с наименованием переменной части коллекции, а также поле, с результатом сопоставления по условию.
![5_result_pusk_block.png](../images/7_Workflow/Mask/5_result_pusk_block.png)

### Выходные данные
Для распределения выходных данных задайте маску по аналогии.
**Например:**

{type}_{system}_processed

**Результат:**

Обработчик создаст отдельные коллекции для каждого типа объекта и системы:

* transformer_SK-11_processed
* circuitbreaker_SPA_processed.

> Если маска не совпадает с именами коллекций, данные не будут обработаны. Имена коллекций должны быть стандартизированы и соответствовать заданной структуре.


# Сводный отчет по результатам сопоставления
Программный обработчик "Сводный отчет" принимает на вход коллекции, и на выходе формирует таблицу со статистикой. Таблица позволяет анализировать данные, переходить к исходным коллекциям и применять фильтры.

Входные данные
На вход могут подаваться следующие типы коллекций:

Исключены из выгрузки: коллекции с перечнем объектов, исключенных из сопоставления.
Выделено: коллекции с перечнем сопоставляемых объектов.
Дубликаты: коллекции, содержащие список объектов из коллекции «Выделено» с повторяющимся ключом сопоставления.
Справочник ключей: коллекции с перечнем сопоставляемых объектов без дубликатов.
Сопоставлено: коллекции с объектами, которые были успешно сопоставлены.
Не сопоставлено: коллекции с объектами, которые не удалось сопоставить. Statistic_workflow.png
Входные коллекции должны содержать обязательные поля:

Система.
Тип объекта. Source_field.png Несколько коллекций могут быть подключены к одному входу обработчика как:

Явно: пользователь вручную выбирает коллекции для входа.

По маске: используется набор коллекций, соответствующих определенным условиям (например, все коллекции одного типа).
Запуск обработчика
Запуск обработчика происходит по аналогии c другими обработчиками текущего раздела.

Формирование отчета
На выходе обработчика формируется коллекция со статистикой (таблица).

Колонки таблицы:

Исключены из выгрузки: количество строк в соответствующих входных коллекциях.
Выделено: количество строк в коллекциях сопоставляемых объектов.
Дубликаты: количество строк с повторяющимися ключами.
Справочник ключей: количество строк сопоставляемых объектов без дубликатов.
Сопоставлено: количество успешно сопоставленных строк.
Не сопоставлено: количество не сопоставленных строк.
% сопост: процент строк в категории «Сопоставлено» относительно «Выделено».
statistic_result.png

Работа с таблицей
Переход к исходным коллекциям

При нажатии на ячейку в колонках «Исключены из выгрузки», «Выделено», «Дубликаты», «Справочник ключей», «Сопоставлено» или «Не сопоставлено» осуществляется переход в исходную коллекцию с наложением фильтра по колонкам Система и Тип объекта.

Этот функционал реализован с использованием сохранения значений фильтра таблицы в адресной строке браузера.

Пример использования
Входные коллекции:

Коллекция «Исключены из выгрузки»: 10 строк.

Коллекция «Выделено»: 100 строк.

Коллекция «Дубликаты»: 20 строк.

Коллекция «Справочник ключей»: 80 строк.

Коллекция «Сопоставлено»: 70 строк.

Коллекция «Не сопоставлено»: 30 строк.

Система	Тип объекта	Исключены из выгрузки	Выделено	Дубликаты	Справочник ключей	Сопоставлено	Не сопоставлено	% сопост
System A|	Object 1	5	50	10	40	35	15	70%
---------------------------------------------------
System B|	Object 2	5	50	10	40	35	15	70%
